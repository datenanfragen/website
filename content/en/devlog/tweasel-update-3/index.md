{
    "title": "Tweasel update #3: Switching to a better unpinning script, fixing bugs and writing docs",
    "type": "devlog",
    "date": "2023-07-28T13:37:30+02:00",
    "description": "The third installment of our semi-regular updates on the development of the tweasel project. This time, we have switched to a different certificate pinning bypass script and fixed various bugs on different platforms and devices. We have also continued working on our documentation and outreach, and collected new traffic data for our TrackHAR adapters.",
    "authors": [ "baltpeter" ]
}

Hello again from the [tweasel project](https://github.com/tweaselORG), where we are creating a web app that analyzes mobile apps for privacy issues. One of the major changes we have made is switching to a different unpinning script for Android, which allows us to bypass certificate pinning more reliably. We have also fixed some bugs that were affecting the installation and usage of our tools and libraries on different platforms and devices. In addition, we have continued working on our documentation and outreach, by creating a new docs site and giving a workshop at the Digitalcourage Aktivcongress. We have also collected some new traffic data that we will use to create and improve our TrackHAR adapters.

## Appstraction

> [Appstraction](https://github.com/tweaselORG/appstraction) is an abstraction layer for common instrumentation functions on Android and iOS. It allows you to install, uninstall, start, stop apps and configure their permissions, as well as manage device settings like emulator snapshots, clipboard, proxy, and certificates. Appstraction can also be used for purposes other than mobile privacy.

* Last time, Lorenz already {{< link slug="devlog/tweasel-update-2#certificate-pinning-bypass" text="talked" >}} about the analysis I had run comparing the unpinning capabilities of [objection](https://github.com/sensepost/objection) and [`httptoolkit/frida-android-unpinning`](https://github.com/httptoolkit/frida-android-unpinning), and we had [decided](https://github.com/tweaselORG/appstraction/issues/110) to switch to `httptoolkit/frida-android-unpinning`. I [finally implemented that](https://github.com/tweaselORG/appstraction/pull/111).

  Doing that, I ran into an [annoying incompatibility between JS bundlers](https://github.com/tweaselORG/appstraction/pull/111#issuecomment-1623576695): We have the unpinning script as a file in our repository. To inject that using Frida, I had read it using Node's `readFile()` function. However, [Parcel](https://parceljs.org/) (which we're using to produce the production builds) was trying to be too smart. It recognized the script as a JS file and bundled it using our settings. However, [its output was not compatible with Frida's JS engine](https://github.com/tweaselORG/appstraction/pull/111#issuecomment-1623563637). Parcel also has [two ways for inlining files without bundling them](https://parceljs.org/features/bundle-inlining/#inlining-without-transforming), but those are custom extensions and don't work with [tsx](https://github.com/esbuild-kit/tsx)/esbuild (which we use for development). I ended up working around this by renaming the file to `.txt`, so that Parcel doesn't recognize it as JS anymore.
* Through the change of the unpinning script, we were also able to fix two issues that were related to how we were calling objection:
    * You can now [catch errors in `startApp()`](https://github.com/tweaselORG/appstraction/issues/101).
    * And we are [not leaking the objection process](https://github.com/tweaselORG/appstraction/issues/24) anymore. Through fixing this, I [learned about Frida's `eternalize()` feature](https://github.com/tweaselORG/appstraction/issues/110#issuecomment-1618258397), which lets you keep a script injected in a process even after detaching from it.
* Lorenz [made using the `ssh` capability on iOS a lot easier](https://github.com/tweaselORG/appstraction/pull/112). Now, you don't have to specify the IP address of the device anymore as we are automatically starting a usbmuxd proxy. We [initially planned to use iproxy](https://github.com/tweaselORG/appstraction/issues/43) for this purpose, but now that we've switched from libimobiledevice to pymobiledevice3, it obviously made more sense to use that.

  With this change, Lorenz also implemented [support for logging in as `mobile` instead of `root`](https://github.com/tweaselORG/appstraction/issues/43#issuecomment-1619944660) as the `root` user may not be available depending on the jailbreak. Unfortunately, you do still need to manually install `openssh` due to a [bug in palera1n](https://github.com/palera1n/jbinit/issues/10).
* I had [noticed a problem with stuck Frida processes](https://github.com/tweaselORG/appstraction/issues/102) after analyzing a lot of apps on Android: After the phone crashed, there was still a Frida process running and any Frida commands just hung indefinitely. Lorenz implemented a fix for that, which [automatically kills such stuck Frida processes](https://github.com/tweaselORG/appstraction/pull/114) `ensureDevice()`.
* We received a bug report that [installing appstraction on macOS hung indefinitely](https://github.com/tweaselORG/appstraction/issues/108) and never completed. After a bit of investigation, I [found](https://github.com/tweaselORG/appstraction/issues/108#issuecomment-1623940975) that the installation got stuck at download the Android dependencies using andromatic. We noticed that we actually had an [existing issue](https://github.com/tweaselORG/andromatic/issues/6) for this problem that we just forgot about! The problem was that the [`find-java-home`](https://github.com/jsdevel/node-find-java-home/) package we were using to try an find an existing Java installation incorrectly returns `/usr` on newer versions of macOS. To fix this, Lorenz [switched](https://github.com/tweaselORG/andromatic/pull/8) to [`@viperproject/locate-java-home`](https://github.com/viperproject/locate-java-home).
* We noticed the [automatic installation of Frida on iOS wasn't working properly](https://github.com/tweaselORG/cli/issues/24). Lorenz [fixed this problem](https://github.com/tweaselORG/appstraction/pull/112/commits/5c283522fdf735a8e85e7a41de4c89793c6746ce) by clearing the `apt` package cache before installing Frida.
* We released these changes in [version 1.0.0](https://github.com/tweaselORG/appstraction/releases/tag/v1.0.0). That release also contains some of the changes we already previewed in the {{< link slug="devlog/tweasel-update-2" text="last update" >}}.
* Since then, we have already discovered two new bugs that we'll have to fix in the next release.
    * We had already [required a Node version `>= 18`](https://github.com/tweaselORG/appstraction/issues/113) because we are using a bunch of newer language features. However, it turns out that the [installation fails no newer versions like Node 20](https://github.com/tweaselORG/appstraction/issues/119). The problem appears to be that [`frida-node` only provides prebuilt binaries for LTS versions of Node](https://github.com/frida/frida-node/issues/87). Looks like we can only support Node 18 for now.
    * We had neglected to test the newer changes on Windows, and—probably unsurprisingly—that resulted in a whole bunch of breakage starting with the [`postinstall` script failing](https://github.com/tweaselORG/appstraction/issues/118).

## Cyanoacrylate

> [Cyanoacrylate](https://github.com/tweaselORG/cyanoacrylate) is a toolkit for large-scale automated traffic analysis of mobile apps on Android and iOS. It uses mitmproxy to capture the HTTP(S) traffic of apps in HAR format and appstraction to instrument physical devices, or emulators for Android. Cyanoacrylate handles the management of certificate authorities and WireGuard mitmproxy setup automatically. It is designed to analyze the tracking behavior of mobile apps.

* I noticed that my previous implementation of exposing mitmproxy events was incomplete. For example, we were [missing the hostname in certificate errors](https://github.com/tweaselORG/meta/issues/16#issuecomment-1602683111). As such, I significantly extended the [existing implementation](https://github.com/tweaselORG/cyanoacrylate/pull/33). We are now exposing pretty much all the information that mitmproxy provides in its events, complete with proper type definitions and docstrings.
* This change was released in [version 1.0.0](https://github.com/tweaselORG/cyanoacrylate/releases/tag/v1.0.0). That release also inherits all changes from the appstraction 1.0.0 release.

## CLI

> [Tweasel CLI](https://github.com/tweaselORG/cli) is a command-line tool that allows you to instrument and analyze mobile apps and their traffic using the tweasel project libraries. You can record the traffic of an Android or iOS app in HAR format (based on cyanoacrylate), and detect tracking data transmissions from the traffic (based on TrackHAR). Tweasel CLI provides a convenient wrapper around these libraries for common use cases, so you don’t have to write any code.

* I made [analysing already installed apps easier in CLI](https://github.com/tweaselORG/cli/issues/27). The [app ID/path argument is now optional](https://github.com/tweaselORG/cli/pull/28). If you don't provide it, you will be prompted to select an app from a list of all apps installed on the device. This especially convenient on iOS, where you can't easily find out the bundle ID of an app.

  {{< video name="cli-app-id-optional.mp4" alt="Screenrecording of using the record-traffic command with only a -p android flag. The user is shown a list of the app IDs of apps installed on the device and prompted to select one for analysis." >}}
* Lorenz fixed a bug where we were [waiting for the Android emulator before we had even started it](https://github.com/tweaselORG/cli/pull/31).
* These changes are released in [version 1.0.0](https://github.com/tweaselORG/cli/releases/tag/v1.0.0), which also inherits all changes from appstraction 1.0.0 and cyanoacrylate 1.0.0.

## Documentation and outreach

* I wrote [ghtivity](https://github.com/tweaselORG/ghtivity), a small utility for displaying the activity in GitHub repositories in a certain time frame to make writing these devlogs easier. I was previously spending way too much time finding all the changes that happened since the last update and that seemed ridiculous.

  {{< img name="ghtivity-screenshot.png" alt="Screenshot showing the output of ghtivity. There are sections for multiple repositories in the tweaselORG organization. Some show activity in the form of issues, pull requests, and/or releases. One doesn't show any activity." >}}
  * Mere minutes after the first release, I noticed two bugs and had to push a quick [v1.0.1 release](https://github.com/tweaselORG/ghtivity/releases/tag/v1.0.1). :)
* We put some thought into [how we want to structure our documenation](https://github.com/tweaselORG/meta/issues/3#issuecomment-1607700481). Our research documentation regarding trackers (to explain why the TrackHAR adapters are the way they are) will live in a separate section on [trackers.tweasel.org](https://trackers.tweasel.org/). For the API reference docs, we will [switch to Typedoc proper](https://github.com/tweaselORG/meta/issues/13).
* And for all other documentation, I have started [docs.tweasel.org](https://docs.tweasel.org/). So far, we already have an introduction that explains the different parts of our project, two tutorials for installing our tools and libraries and how do do traffic analysis with CLI, and a section describing common problems and how to solve them. We plan to extend this in the future, for example with a background section that explains the technical details of how our tools work and our dependencies.
    * We have an [open issue for updating our READMEs](https://github.com/tweaselORG/meta/issues/34).
* Lorenz and I were at the [Digitalcourage Aktivcongress](https://digitalcourage.de/blog/2023/aktivcongress-2023) in Remscheid, an information exchange and networking events for people active in the data protection/digital rights movement that was organised by [Digitalcourage](https://digitalcourage.de/en). We gave a workshop on how to install and use our tools. As all workshops at the event were fairly ad-hoc, we don't have a presentation that we can share, but we essentially just followed the [tutorials on our new docs site](https://docs.tweasel.org/usage/).
* I want to work on creating new adapters for TrackHAR and [properly documenting the existing ones](https://github.com/tweaselORG/TrackHAR/issues/9) next but noticed that the most recent traffic data we have is now almost a year old. Thus, I ran a [new collection](https://github.com/tweaselORG/experiments/issues/1) on ~1000 apps each on Android and iOS. On Android, I used the [monkey](https://developer.android.com/studio/test/other-testing-tools/monkey) to generate some random user input and hopefully trigger more requests. I collected 126,161 requests in total, which should give us a good basis for future work.  
  We'll release the data through our [public request database](https://github.com/tweaselORG/meta/issues/33), which is almost ready to be published.
